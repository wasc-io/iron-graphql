<!--
Copyright (c) 2017 wasc GbR. All rights reserved.
This code may only be used under the BSD style license found at https://wasc-io.github.io/LICENSE.txt
-->
<link rel="import" href="../polymer/polymer-element.html">
<!--
Simple iron-graphql element. Query GraphQL APIs with this elements.
`iron-graphql` 

@demo demo/index.html
-->

<dom-module id="iron-graphql">
  <template>
    <style>
       :host {
        display: block;
      }
    </style>
  </template>

  <script>
    /** @polymerElement */
    class IronGraphQL extends Polymer.Element {
      static get is() {
        return 'iron-graphql';
      }
      static get properties() {
        return {
          url: {
            type: String,
            observer: '_urlChanged'
          },
          query: {
            type: String,
            notify: true,
          },
          variables: {
            type: Object,
            notify: true,
          },
          lastResponse: {
            type: JSON,
            notify: true,
            readOnly: true,
            value: {}
          },
          headers: {
            type: Object,
            notify: true,
          },
          bearerToken: {
            type: String,
          },
          auto: {
            type: Boolean,
          }
        }
      }

      _urlChanged() {
        if (this.auto) {
          this.generateRequest();
        }
      }

      generateRequest() {
        let body = {
          query: this.query,
        };

        if (this.variables) {
          body.variables = this.variables
        };

        body.query = this.query;
        post(this.url, body, this.headers, this.bearerToken).then((response) => {
          this.set('lastResponse.data', response.data);

          this.dispatchEvent(new CustomEvent('response', {
            detail: response,
            composed: true,
            bubbles: true,
          }));
        })
          .catch((error) => {
            console.error(error);
          });
      }

    }

    function post(url, body, headers, bearerToken) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.responseType = 'json';
        xhr.open('POST', url);

        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Accept', 'application/json');
        if (headers) {
          Object.keys(headers).forEach((requestHeader) => {
            xhr.setRequestHeader(requestHeader, headers[requestHeader]);
          });
        }

        if (bearerToken) {
          xhr.setRequestHeader('Authorization', `Bearer ${bearerToken}`);
        }

        xhr.onload = () => {
          if (xhr.status == 200) {
            if (xhr.response.errors) {
              reject(xhr.response.errors);
            } else {
              resolve(xhr.response);
            }
          } else {
            reject(xhr.response);
          }
        };

        xhr.onerror = () => {
          reject(Error('Network Error'));
        };

        xhr.send(body);

      })
    }

    window.customElements.define(IronGraphQL.is, IronGraphQL);
  </script>
</dom-module>